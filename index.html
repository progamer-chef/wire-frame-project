<!DOCTYPE html>
<html lang="en">
<head>
  <title> 展自</title>
  <link rel="icon" href="展自icon.jpeg">
  <style>
    /* Basic Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* Minimum page size */
    html, body {
      min-width: 500px;
      min-height: 375px;
    }
    
    /* Body fills viewport */
    body {
      font-family: monospace;
      height: 100vh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: hsl(0, 0%, 97%);
      position: relative;
      overflow: auto;
    }
    
    /* Main container styling */
    .main-container {
      width: 80vw;
      height: 65vh;
      min-width: 400px;
      min-height: 244px;
      border: 2px solid black;
      background-color: white;
      position: relative;
    }
    
    /* Top area now 33% of main-container */
    .top-half {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 33%;
      overflow: hidden;
    }
    
    /* Bottom area now occupies 67% of main-container */
    .bottom-half {
      position: absolute;
      top: 33%;
      left: 0;
      width: 100%;
      height: 67%;
      overflow: hidden;
      padding: 10px;
    }
    
    /* Contenteditable text input */
    .editable {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      text-align: center;
      font-family: "Times New Roman", Times, serif;
      color: black;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      outline: none;
    }
    
    .editable:empty::before {
      content: attr(data-placeholder);
      color: #aaa;
    }
    
    /* Hide file input UI */
    #file-input {
      display: none;
    }
    
    /* Upload container for files */
    #upload-container {
      width: 100%;
      height: calc(100% - 40px);
      overflow: hidden;
      position: relative;
      background-color: #FFFFFF;
    }
    
    /* File box styling – no visible border, absolute positioning */
    .file-box {
      overflow: hidden;
      position: absolute;
      cursor: move;
      user-select: none;
    }
    
    /* Glowing light-blue boundary on hover for file boxes */
    .file-box:hover {
      outline: 2px solid #ADD8E6;
      box-shadow: 0 0 8px #ADD8E6;
    }
    
    /* Images: fill container exactly */
    .file-box img {
      width: 100%;
      height: 100%;
      object-fit: fill;
      pointer-events: none;
    }
    
    /* Videos: fill container exactly; pointer events disabled in room mode */
    .file-box video {
      width: 100%;
      height: 100%;
      object-fit: fill;
      pointer-events: none;
    }
    
    /* Audio visual representation: red/blue box */
    .audio-box {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .audio-box .top-half {
      background-color: red;
      flex: 1;
    }
    .audio-box .bottom-half {
      background-color: blue;
      flex: 1;
    }
    
    /* Diagonal lines */
    .line {
      position: absolute;
      background-color: black;
      height: 2px;
    }
    
    /* SVG container for parallelogram */
    #parallelogram-svg {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    
    /* --- View Mode Styles (detail view) ---
         These styles control the presentation for non-audio files.
         (Audio view mode is handled separately below.)
    */
    #detail-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: white;
      display: none;
      z-index: 1000;
    }
    .detail-layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* For horizontal layout: file on top, textbox below */
    .detail-layout.horizontal {
      flex-direction: column;
    }
    /* For vertical layout: textbox on left, file on right */
    .detail-layout.vertical {
      flex-direction: row;
    }
    .detail-layout > div {
      box-sizing: border-box;
      overflow: auto;
      margin: 0;
      padding: 0;
      border: none;
    }
    /* Horizontal layout dimensions */
    #detail-file-container.horizontal,
    #detail-text-container.horizontal {
      width: 100%;
      height: 50%;
    }
    /* Vertical layout dimensions */
    #detail-file-container.vertical,
    #detail-text-container.vertical {
      width: 50%;
      height: 100%;
    }
    /* Make media in view mode scale nicely */
    #detail-file-container img,
    #detail-file-container video,
    #detail-file-container audio,
    #detail-file-container .audio-box {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      margin: auto;
    }
    /* Detail textbox styling for non-audio view modes */
    #detail-text {
      width: 100%;
      height: 100%;
      font-family: monospace;
      font-size: 1rem;
      padding: 10px;
      box-sizing: border-box;
      border: none;
      resize: none;
    }
    /* Close button styling */
    #detail-close {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      z-index: 1100;
      cursor: pointer;
    }
  </style>
</head>
<body>
  
  <div class="main-container">
    <!-- Top area for text input -->
    <div class="top-half">
      <div class="editable" contenteditable="true" data-placeholder="intimately, not infinitely."></div>
    </div>
    <!-- Bottom area for file uploads -->
    <div class="bottom-half">
      <input type="file" id="file-input" multiple accept="image/*,video/*,audio/*">
      <div id="upload-container"></div>
    </div>
  </div>
  
  <!-- Diagonal lines -->
  <div class="line" id="line-top-left"></div>
  <div class="line" id="line-top-right"></div>
  <div class="line" id="line-bottom-left"></div>
  <div class="line" id="line-bottom-right"></div>
  
  <!-- SVG container for parallelogram -->
  <svg id="parallelogram-svg">
    <polygon id="parallelogram-poly" fill="none" stroke="black" stroke-width="2"></polygon>
  </svg>
  
  <!-- View mode overlay (detail view) -->
  <div id="detail-view">
    <button id="detail-close">back</button>
    <!-- The view mode layout will be generated dynamically here -->
  </div>
  
  <script>
    // Global variable to track playable media moved to view mode.
    // For audio files, we also store the full-screen containers.
    let currentDetailMediaInfo = null;
    
    // DRAWING FUNCTIONS (unchanged)
    function drawLinesAndParallelogram() {
      const container = document.querySelector(".main-container");
      const rect = container.getBoundingClientRect();
      
      const containerPageRect = {
        left: rect.left + window.pageXOffset,
        top: rect.top + window.pageYOffset,
        right: rect.right + window.pageXOffset,
        bottom: rect.bottom + window.pageYOffset
      };
      
      const minPageWidth = 500;
      const minPageHeight = 375;
      let docWidth = Math.max(window.innerWidth, minPageWidth);
      let docHeight = Math.max(window.innerHeight, minPageHeight);
      
      const svg = document.getElementById("parallelogram-svg");
      svg.style.width = docWidth + "px";
      svg.style.height = docHeight + "px";
      
      const docCorners = {
        topLeft: { x: 0, y: 0 },
        topRight: { x: docWidth, y: 0 },
        bottomLeft: { x: 0, y: docHeight },
        bottomRight: { x: docWidth, y: docHeight }
      };
      
      const corners = {
        topLeft: { x: containerPageRect.left, y: containerPageRect.top },
        topRight: { x: containerPageRect.right, y: containerPageRect.top },
        bottomLeft: { x: containerPageRect.left, y: containerPageRect.bottom },
        bottomRight: { x: containerPageRect.right, y: containerPageRect.bottom }
      };
      
      function getDiagonalLength(x1, y1, x2, y2) {
        return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
      }
      
      function setLine(lineId, start, end) {
        const line = document.getElementById(lineId);
        const length = getDiagonalLength(start.x, start.y, end.x, end.y);
        const angle = Math.atan2(end.y - start.y, end.x - start.x) * (180 / Math.PI);
        line.style.width = `${length}px`;
        line.style.transform = `rotate(${angle}deg)`;
        line.style.transformOrigin = "0 0";
        line.style.left = `${start.x}px`;
        line.style.top = `${start.y}px`;
      }
      
      setLine("line-top-left", corners.topLeft, docCorners.topLeft);
      setLine("line-top-right", corners.topRight, docCorners.topRight);
      setLine("line-bottom-left", corners.bottomLeft, docCorners.bottomLeft);
      setLine("line-bottom-right", corners.bottomRight, docCorners.bottomRight);
      
      const desiredVerticalOffset = 100;
      const desiredBaseInset = 900;
      const minEffectiveBaseLength = 60;
      const minVerticalOffset = 30;
      
      const P = { x: 0, y: docHeight };
      const Q = { x: corners.bottomLeft.x, y: corners.bottomLeft.y };
      const dx = Q.x - P.x;
      const dy = Q.y - P.y;
      const baseLength = Math.sqrt(dx * dx + dy * dy);
      const unit = { x: dx / baseLength, y: dy / baseLength };
      
      let baseInset = desiredBaseInset;
      let effectiveBaseLength = baseLength - 2 * baseInset;
      if (effectiveBaseLength < minEffectiveBaseLength) {
        baseInset = Math.max(0, (baseLength - minEffectiveBaseLength) / 2);
        effectiveBaseLength = baseLength - 2 * baseInset;
      }
      
      const A = { x: P.x + baseInset * unit.x, y: P.y + baseInset * unit.y };
      const B = { x: Q.x - baseInset * unit.x, y: Q.y - baseInset * unit.y };
      const verticalOffset = Math.max(desiredVerticalOffset, minVerticalOffset);
      const D = { x: A.x, y: A.y - verticalOffset };
      const C = { x: B.x, y: B.y - verticalOffset };
      const pointsStr = `${A.x},${A.y} ${B.x},${B.y} ${C.x},${C.y} ${D.x},${D.y}`;
      
      const polygon = document.getElementById("parallelogram-poly");
      polygon.setAttribute("points", pointsStr);
      
      const oldHLines = document.querySelectorAll(".h-line");
      oldHLines.forEach(line => line.remove());
      
      const numHLines = 12;
      const spacingFactor = 0.1;
      const yBottomBox = corners.bottomLeft.y;
      const yBottomDoc = docCorners.bottomLeft.y;
      
      for (let i = 0; i < numHLines; i++) {
          const t = Math.log(1 + (numHLines - 1 - i) * spacingFactor) /
                    Math.log(1 + (numHLines - 1) * spacingFactor);
          const y_line = yBottomBox + (1 - t) * (yBottomDoc - yBottomBox);
          const t_line = (y_line - yBottomBox) / (yBottomDoc - yBottomBox);
          const x_left = containerPageRect.left * (1 - t_line);
          const x_right = containerPageRect.right + t_line * (docWidth - containerPageRect.right);
          const hLine = document.createElement("div");
          hLine.className = "h-line";
          hLine.style.position = "absolute";
          hLine.style.top = y_line + "px";
          hLine.style.left = x_left + "px";
          hLine.style.width = (x_right - x_left) + "px";
          hLine.style.height = "2px";
          hLine.style.backgroundColor = "black";
          document.body.appendChild(hLine);
      }
    }
    
    // ------------------------------
    // DRAG & DROP / FILE HANDLING
    // ------------------------------
    
    function setupDragAndDrop() {
      const uploadContainer = document.getElementById("upload-container");
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      
      uploadContainer.addEventListener('dragover', () => {
        uploadContainer.style.backgroundColor = "#D3D3D3";
      });
      
      uploadContainer.addEventListener('dragleave', () => {
        uploadContainer.style.backgroundColor = "#FFFFFF";
      });
      
      uploadContainer.addEventListener('drop', (e) => {
        uploadContainer.style.backgroundColor = "#FFFFFF";
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
    }
    
    function handleFiles(files) {
      const uploadContainer = document.getElementById("upload-container");
      for (let file of files) {
        if (uploadContainer.children.length >= 3) {
          alert("3 files maximum");
          break;
        }
        createFileBox(file);
      }
    }
    
    // Create a file box for a given file (using your existing logic).
    function createFileBox(file) {
      const uploadContainer = document.getElementById("upload-container");
      const fileBox = document.createElement("div");
      fileBox.classList.add("file-box");
      
      if (file.type.startsWith("image/")) {
        const img = new Image();
        img.onload = function() {
          const naturalWidth = img.naturalWidth;
          const naturalHeight = img.naturalHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(img);
          fileBox.mediaType = "image";
          fileBox.mediaElement = img;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        img.src = URL.createObjectURL(file);
      } else if (file.type.startsWith("video/")) {
        const video = document.createElement("video");
        video.loop = true;
        video.controls = false;
        video.style.pointerEvents = "none";
        video.onloadedmetadata = function() {
          const naturalWidth = video.videoWidth;
          const naturalHeight = video.videoHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(video);
          fileBox.mediaType = "video";
          fileBox.mediaElement = video;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        video.src = URL.createObjectURL(file);
      } else if (file.type.startsWith("audio/")) {
        // For audio, use a fixed 25x25px square.
        const newWidth = 25;
        const newHeight = 25;
        fileBox.style.width = newWidth + "px";
        fileBox.style.height = newHeight + "px";
        fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
        fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
        const audio = document.createElement("audio");
        audio.loop = true;
        audio.controls = false;
        audio.style.display = "none";
        audio.src = URL.createObjectURL(file);
        const audioBox = document.createElement("div");
        audioBox.className = "audio-box";
        const topDiv = document.createElement("div");
        topDiv.className = "top-half";
        const bottomDiv = document.createElement("div");
        bottomDiv.className = "bottom-half";
        audioBox.appendChild(topDiv);
        audioBox.appendChild(bottomDiv);
        fileBox.appendChild(audioBox);
        fileBox.appendChild(audio);
        fileBox.mediaType = "audio";
        fileBox.mediaElement = audio;
        fileBox.audioVisual = audioBox;
        saveRelativeDimensions(fileBox, uploadContainer);
        makeInteractive(fileBox);
        audio.addEventListener("play", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        audio.addEventListener("pause", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        updateAudioVisualColors(audio, fileBox.audioVisual);
      } else {
        const newWidth = 200;
        const newHeight = 200;
        fileBox.style.width = newWidth + "px";
        fileBox.style.height = newHeight + "px";
        fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
        fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
        const fileLink = document.createElement("a");
        fileLink.href = URL.createObjectURL(file);
        fileLink.textContent = file.name;
        fileLink.target = "_blank";
        fileBox.appendChild(fileLink);
        saveRelativeDimensions(fileBox, uploadContainer);
        makeInteractive(fileBox);
      }
      
      fileBox.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Cut file?")) {
          fileBox.remove();
        }
      });
      
      fileBox.addEventListener("click", function(e) {
        if (fileBox.mediaType === "video" || fileBox.mediaType === "audio") {
          const media = fileBox.mediaElement;
          if (media.paused){
            media.play();
          } else {
            media.pause();
          }
        }
      });
      
      fileBox.addEventListener("dblclick", function(e) {
        openDetailView(fileBox);
      });
      
      uploadContainer.appendChild(fileBox);
    }
    
    function saveRelativeDimensions(el, container) {
      el.dataset.relLeft = parseFloat(el.style.left) / container.clientWidth;
      el.dataset.relTop = parseFloat(el.style.top) / container.clientHeight;
      el.dataset.relWidth = parseFloat(el.style.width) / container.clientWidth;
      el.dataset.relHeight = parseFloat(el.style.height) / container.clientHeight;
    }
    
    function updateFileBoxesPositions() {
      const uploadContainer = document.getElementById("upload-container");
      for (const fileBox of uploadContainer.children) {
        if (fileBox.dataset.relLeft) {
          fileBox.style.left = (parseFloat(fileBox.dataset.relLeft) * uploadContainer.clientWidth) + "px";
          fileBox.style.top = (parseFloat(fileBox.dataset.relTop) * uploadContainer.clientHeight) + "px";
          fileBox.style.width = (parseFloat(fileBox.dataset.relWidth) * uploadContainer.clientWidth) + "px";
          fileBox.style.height = (parseFloat(fileBox.dataset.relHeight) * uploadContainer.clientHeight) + "px";
        }
      }
    }
    
    // ------------------------------
    // INTERACTIVE (DRAG & RESIZE) FUNCTIONALITY
    // ------------------------------
    
    function makeInteractive(el) {
      const threshold = 10;
      el.addEventListener("mousedown", function(e) {
        e.preventDefault();
        const rect = {
          left: el.offsetLeft,
          top: el.offsetTop,
          width: el.offsetWidth,
          height: el.offsetHeight
        };
        const relativeX = e.offsetX;
        const relativeY = e.offsetY;
        let corner = null;
        if (relativeX < threshold && relativeY < threshold) {
          corner = "top-left";
        } else if (relativeX > rect.width - threshold && relativeY < threshold) {
          corner = "top-right";
        } else if (relativeX < threshold && relativeY > rect.height - threshold) {
          corner = "bottom-left";
        } else if (relativeX > rect.width - threshold && relativeY > rect.height - threshold) {
          corner = "bottom-right";
        }
        const parent = el.parentElement;
        function updateRelative() {
          el.dataset.relLeft = parseFloat(el.style.left) / parent.clientWidth;
          el.dataset.relTop = parseFloat(el.style.top) / parent.clientHeight;
          el.dataset.relWidth = parseFloat(el.style.width) / parent.clientWidth;
          el.dataset.relHeight = parseFloat(el.style.height) / parent.clientHeight;
        }
        if (corner) {
          document.body.style.cursor = (corner === "top-left" || corner === "bottom-right") ? "nwse-resize" : "nesw-resize";
          const startX = e.clientX, startY = e.clientY;
          const startWidth = rect.width, startHeight = rect.height;
          const startLeft = rect.left, startTop = rect.top;
          function resizeMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newWidth = startWidth, newHeight = startHeight;
            let newLeft = startLeft, newTop = startTop;
            if (corner === "top-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight - dy;
              newLeft = startLeft + dx;
              newTop = startTop + dy;
            } else if (corner === "top-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight - dy;
              newTop = startTop + dy;
            } else if (corner === "bottom-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight + dy;
              newLeft = startLeft + dx;
            } else if (corner === "bottom-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight + dy;
            }
            newWidth = Math.max(newWidth, 30);
            newHeight = Math.max(newHeight, 30);
            newLeft = Math.max(0, newLeft);
            newTop = Math.max(0, newTop);
            if(newLeft + newWidth > parent.clientWidth){
              newWidth = parent.clientWidth - newLeft;
            }
            if(newTop + newHeight > parent.clientHeight){
              newHeight = parent.clientHeight - newTop;
            }
            el.style.width = newWidth + "px";
            el.style.height = newHeight + "px";
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function resizeEnd() {
            document.body.style.cursor = "default";
            document.removeEventListener("mousemove", resizeMove);
            document.removeEventListener("mouseup", resizeEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", resizeMove);
          document.addEventListener("mouseup", resizeEnd);
        } else {
          parent.style.outline = "2px solid red";
          const startX = e.clientX, startY = e.clientY;
          const startLeft = el.offsetLeft;
          const startTop = el.offsetTop;
          function dragMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            newLeft = Math.max(0, Math.min(newLeft, parent.clientWidth - el.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, parent.clientHeight - el.offsetHeight));
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function dragEnd() {
            parent.style.outline = "";
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", dragEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", dragMove);
          document.addEventListener("mouseup", dragEnd);
        }
      });
    }
    
    // ------------------------------
    // VIEW MODE FUNCTIONALITY (Double-Click)
    // ------------------------------
    
    function openDetailView(fileBox) {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "block";
      detailView.querySelectorAll(".detail-layout").forEach(el => el.remove());
      
      // Save current text if not already set.
      if (typeof fileBox.savedText === "undefined") {
        fileBox.savedText = "";
      }
      
      // Special handling for audio files:
      if (fileBox.mediaType === "audio") {
        const audioVisual = fileBox.audioVisual;
        if (audioVisual && audioVisual.parentElement === fileBox) {
          fileBox.removeChild(audioVisual);
        }
        const audioVisualContainer = document.createElement("div");
        audioVisualContainer.id = "audioVisualContainer";
        audioVisualContainer.style.position = "absolute";
        audioVisualContainer.style.top = "0";
        audioVisualContainer.style.left = "0";
        audioVisualContainer.style.width = "100vw";
        audioVisualContainer.style.height = "100vh";
        audioVisualContainer.style.zIndex = "1";
        audioVisual.style.width = "100%";
        audioVisual.style.height = "100%";
        audioVisualContainer.appendChild(audioVisual);
        
        const blackBoxContainer = document.createElement("div");
        blackBoxContainer.style.position = "absolute";
        blackBoxContainer.style.top = "50%";
        blackBoxContainer.style.left = "50%";
        blackBoxContainer.style.transform = "translate(-50%, -50%)";
        blackBoxContainer.style.width = "34vw";
        blackBoxContainer.style.height = "34vh";
        blackBoxContainer.style.backgroundColor = "black";
        blackBoxContainer.style.zIndex = "2";
        const textBox = document.createElement("textarea");
        textBox.id = "detail-text";
        textBox.placeholder = "Enter text here...";
        textBox.style.width = "100%";
        textBox.style.height = "100%";
        textBox.style.background = "transparent";
        textBox.style.border = "none";
        textBox.style.outline = "none";
        textBox.style.color = "white";
        textBox.style.fontFamily = '"Times New Roman", Times, serif';
        textBox.style.fontSize = "3vw";
        textBox.style.resize = "none";
        textBox.value = fileBox.savedText;
        textBox.addEventListener("input", function(){
          fileBox.savedText = textBox.value;
        });
        blackBoxContainer.appendChild(textBox);
        
        detailView.appendChild(audioVisualContainer);
        detailView.appendChild(blackBoxContainer);
        
        currentDetailMediaInfo = { 
          fileBox: fileBox, 
          mediaVisual: audioVisual, 
          audioVisualContainer: audioVisualContainer, 
          blackBoxContainer: blackBoxContainer, 
          isAudio: true, 
          mediaElement: fileBox.mediaElement 
        };
        return;
      }
      
      // For image and video files, use the previous halves layout.
      let fileWidth = fileBox.offsetWidth;
      let fileHeight = fileBox.offsetHeight;
      let layoutType = (fileWidth > fileHeight) ? "horizontal" : "vertical";
      const layoutDiv = document.createElement("div");
      layoutDiv.classList.add("detail-layout", layoutType);
      
      const fileContainer = document.createElement("div");
      fileContainer.id = "detail-file-container";
      fileContainer.classList.add(layoutType);
      const textContainer = document.createElement("div");
      textContainer.id = "detail-text-container";
      textContainer.classList.add(layoutType);
      
      let mediaElement;
      if (fileBox.mediaType === "video") {
        mediaElement = fileBox.mediaElement;
        mediaElement.style.pointerEvents = "auto";
        if (mediaElement.parentElement === fileBox) {
          fileBox.removeChild(mediaElement);
        }
        currentDetailMediaInfo = { fileBox: fileBox, mediaElement: mediaElement };
        mediaElement.addEventListener("click", toggleMediaPlay);
      } else if (fileBox.mediaType === "image") {
        mediaElement = document.createElement("img");
        mediaElement.src = fileBox.querySelector("img").src;
      } else {
        mediaElement = fileBox.cloneNode(true);
      }
      
      fileContainer.appendChild(mediaElement);
      
      const textBox = document.createElement("textarea");
      textBox.id = "detail-text";
      textBox.placeholder = "Enter text here...";
      textBox.value = fileBox.savedText;
      textBox.addEventListener("input", function(){
        fileBox.savedText = textBox.value;
      });
      textContainer.appendChild(textBox);
      
      if (layoutType === "horizontal") {
        layoutDiv.appendChild(fileContainer);
        layoutDiv.appendChild(textContainer);
      } else {
        layoutDiv.appendChild(textContainer);
        layoutDiv.appendChild(fileContainer);
      }
      
      detailView.appendChild(layoutDiv);
    }
    
    function toggleMediaPlay(e) {
      const media = e.currentTarget;
      if (media.paused) {
        media.play();
      } else {
        media.pause();
      }
    }
    
    function audioVisualToggle(e) {
      if (!currentDetailMediaInfo || !currentDetailMediaInfo.mediaElement) return;
      const audio = currentDetailMediaInfo.mediaElement;
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
    }
    
    function updateAudioVisualColors(audio, visual) {
      if (!audio || !visual) return;
      const topDiv = visual.querySelector('.top-half');
      const bottomDiv = visual.querySelector('.bottom-half');
      if (audio.paused) {
        topDiv.style.backgroundColor = "red";
        bottomDiv.style.backgroundColor = "blue";
      } else {
        topDiv.style.backgroundColor = "#2fff00";
        bottomDiv.style.backgroundColor = "#b400ff";
      }
    }
    
    document.getElementById("detail-close").addEventListener("click", function() {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "none";
      
      if (currentDetailMediaInfo) {
        if (currentDetailMediaInfo.isAudio) {
          if (currentDetailMediaInfo.audioVisualContainer && currentDetailMediaInfo.audioVisualContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.audioVisualContainer);
          }
          if (currentDetailMediaInfo.blackBoxContainer && currentDetailMediaInfo.blackBoxContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.blackBoxContainer);
          }
          currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
        } else {
          if (currentDetailMediaInfo.mediaElement &&
              currentDetailMediaInfo.mediaElement.tagName.toLowerCase() === "video") {
            currentDetailMediaInfo.mediaElement.removeEventListener("click", toggleMediaPlay);
            currentDetailMediaInfo.mediaElement.style.pointerEvents = "none";
          }
          if (currentDetailMediaInfo.mediaVisual) {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
          } else {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaElement);
          }
        }
        currentDetailMediaInfo = null;
      }
    });
    
    // --- Default Layout Initialization ---
    // Here you can add default text and default file boxes when the page loads.
    // For example, you might pre-populate the editable text area and create default file boxes.
    // The following function creates default file boxes based on a default file object.
    function createDefaultFileBox(defaultFile) {
      // defaultFile is an object with keys: type ("image", "video", "audio") and src (URL)
      // Here we simulate a file box similar to createFileBox(), but using default data.
      const uploadContainer = document.getElementById("upload-container");
      const fileBox = document.createElement("div");
      fileBox.classList.add("file-box");
      // Initialize savedText property.
      fileBox.savedText = "";
      
      if (defaultFile.type === "image") {
        const img = new Image();
        img.onload = function() {
          const naturalWidth = img.naturalWidth;
          const naturalHeight = img.naturalHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(img);
          fileBox.mediaType = "image";
          fileBox.mediaElement = img;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        img.src = defaultFile.src;
      } else if (defaultFile.type === "video") {
        const video = document.createElement("video");
        video.loop = true;
        video.controls = false;
        video.style.pointerEvents = "none";
        video.onloadedmetadata = function() {
          const naturalWidth = video.videoWidth;
          const naturalHeight = video.videoHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(video);
          fileBox.mediaType = "video";
          fileBox.mediaElement = video;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        video.src = defaultFile.src;
      } else if (defaultFile.type === "audio") {
        // For audio, we use a fixed 25x25px square.
        const newWidth = 25;
        const newHeight = 25;
        fileBox.style.width = newWidth + "px";
        fileBox.style.height = newHeight + "px";
        fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
        fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
        const audio = document.createElement("audio");
        audio.loop = true;
        audio.controls = false;
        audio.style.display = "none";
        audio.src = defaultFile.src;
        const audioBox = document.createElement("div");
        audioBox.className = "audio-box";
        const topDiv = document.createElement("div");
        topDiv.className = "top-half";
        const bottomDiv = document.createElement("div");
        bottomDiv.className = "bottom-half";
        audioBox.appendChild(topDiv);
        audioBox.appendChild(bottomDiv);
        fileBox.appendChild(audioBox);
        fileBox.appendChild(audio);
        fileBox.mediaType = "audio";
        fileBox.mediaElement = audio;
        fileBox.audioVisual = audioBox;
        saveRelativeDimensions(fileBox, uploadContainer);
        makeInteractive(fileBox);
        audio.addEventListener("play", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        audio.addEventListener("pause", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        updateAudioVisualColors(audio, fileBox.audioVisual);
      }
      
      fileBox.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Cut file?")) {
          fileBox.remove();
        }
      });
      
      fileBox.addEventListener("click", function(e) {
        if (fileBox.mediaType === "video" || fileBox.mediaType === "audio") {
          const media = fileBox.mediaElement;
          if (media.paused){
            media.play();
          } else {
            media.pause();
          }
        }
      });
      
      fileBox.addEventListener("dblclick", function(e) {
        openDetailView(fileBox);
      });
      
      uploadContainer.appendChild(fileBox);
    }
    
    // ------------------------------
    // INTERACTIVE (DRAG & RESIZE) FUNCTIONALITY
    // ------------------------------
    
    function makeInteractive(el) {
      const threshold = 10;
      el.addEventListener("mousedown", function(e) {
        e.preventDefault();
        const rect = {
          left: el.offsetLeft,
          top: el.offsetTop,
          width: el.offsetWidth,
          height: el.offsetHeight
        };
        const relativeX = e.offsetX;
        const relativeY = e.offsetY;
        let corner = null;
        if (relativeX < threshold && relativeY < threshold) {
          corner = "top-left";
        } else if (relativeX > rect.width - threshold && relativeY < threshold) {
          corner = "top-right";
        } else if (relativeX < threshold && relativeY > rect.height - threshold) {
          corner = "bottom-left";
        } else if (relativeX > rect.width - threshold && relativeY > rect.height - threshold) {
          corner = "bottom-right";
        }
        const parent = el.parentElement;
        function updateRelative() {
          el.dataset.relLeft = parseFloat(el.style.left) / parent.clientWidth;
          el.dataset.relTop = parseFloat(el.style.top) / parent.clientHeight;
          el.dataset.relWidth = parseFloat(el.style.width) / parent.clientWidth;
          el.dataset.relHeight = parseFloat(el.style.height) / parent.clientHeight;
        }
        if (corner) {
          document.body.style.cursor = (corner === "top-left" || corner === "bottom-right") ? "nwse-resize" : "nesw-resize";
          const startX = e.clientX, startY = e.clientY;
          const startWidth = rect.width, startHeight = rect.height;
          const startLeft = rect.left, startTop = rect.top;
          function resizeMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newWidth = startWidth, newHeight = startHeight;
            let newLeft = startLeft, newTop = startTop;
            if (corner === "top-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight - dy;
              newLeft = startLeft + dx;
              newTop = startTop + dy;
            } else if (corner === "top-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight - dy;
              newTop = startTop + dy;
            } else if (corner === "bottom-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight + dy;
              newLeft = startLeft + dx;
            } else if (corner === "bottom-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight + dy;
            }
            newWidth = Math.max(newWidth, 30);
            newHeight = Math.max(newHeight, 30);
            newLeft = Math.max(0, newLeft);
            newTop = Math.max(0, newTop);
            if(newLeft + newWidth > parent.clientWidth){
              newWidth = parent.clientWidth - newLeft;
            }
            if(newTop + newHeight > parent.clientHeight){
              newHeight = parent.clientHeight - newTop;
            }
            el.style.width = newWidth + "px";
            el.style.height = newHeight + "px";
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function resizeEnd() {
            document.body.style.cursor = "default";
            document.removeEventListener("mousemove", resizeMove);
            document.removeEventListener("mouseup", resizeEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", resizeMove);
          document.addEventListener("mouseup", resizeEnd);
        } else {
          parent.style.outline = "2px solid red";
          const startX = e.clientX, startY = e.clientY;
          const startLeft = el.offsetLeft;
          const startTop = el.offsetTop;
          function dragMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            newLeft = Math.max(0, Math.min(newLeft, parent.clientWidth - el.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, parent.clientHeight - el.offsetHeight));
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function dragEnd() {
            parent.style.outline = "";
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", dragEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", dragMove);
          document.addEventListener("mouseup", dragEnd);
        }
      });
    }
    
    // ------------------------------
    // VIEW MODE FUNCTIONALITY (Double-Click)
    // ------------------------------
    
    function openDetailView(fileBox) {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "block";
      detailView.querySelectorAll(".detail-layout").forEach(el => el.remove());
      
      // Save text changes so they persist.
      if (typeof fileBox.savedText === "undefined") {
        fileBox.savedText = "";
      }
      
      // Special handling for audio files:
      if (fileBox.mediaType === "audio") {
        const audioVisual = fileBox.audioVisual;
        if (audioVisual && audioVisual.parentElement === fileBox) {
          fileBox.removeChild(audioVisual);
        }
        const audioVisualContainer = document.createElement("div");
        audioVisualContainer.id = "audioVisualContainer";
        audioVisualContainer.style.position = "absolute";
        audioVisualContainer.style.top = "0";
        audioVisualContainer.style.left = "0";
        audioVisualContainer.style.width = "100vw";
        audioVisualContainer.style.height = "100vh";
        audioVisualContainer.style.zIndex = "1";
        audioVisual.style.width = "100%";
        audioVisual.style.height = "100%";
        audioVisualContainer.appendChild(audioVisual);
        
        const blackBoxContainer = document.createElement("div");
        blackBoxContainer.style.position = "absolute";
        blackBoxContainer.style.top = "50%";
        blackBoxContainer.style.left = "50%";
        blackBoxContainer.style.transform = "translate(-50%, -50%)";
        blackBoxContainer.style.width = "34vw";
        blackBoxContainer.style.height = "34vh";
        blackBoxContainer.style.backgroundColor = "black";
        blackBoxContainer.style.zIndex = "2";
        const textBox = document.createElement("textarea");
        textBox.id = "detail-text";
        textBox.placeholder = "Enter text here...";
        textBox.style.width = "100%";
        textBox.style.height = "100%";
        textBox.style.background = "transparent";
        textBox.style.border = "none";
        textBox.style.outline = "none";
        textBox.style.color = "white";
        textBox.style.fontFamily = '"Times New Roman", Times, serif';
        textBox.style.fontSize = "3vw";
        textBox.style.resize = "none";
        textBox.value = fileBox.savedText;
        textBox.addEventListener("input", function(){
          fileBox.savedText = textBox.value;
        });
        blackBoxContainer.appendChild(textBox);
        
        detailView.appendChild(audioVisualContainer);
        detailView.appendChild(blackBoxContainer);
        
        currentDetailMediaInfo = { 
          fileBox: fileBox, 
          mediaVisual: audioVisual, 
          audioVisualContainer: audioVisualContainer, 
          blackBoxContainer: blackBoxContainer, 
          isAudio: true, 
          mediaElement: fileBox.mediaElement 
        };
        return;
      }
      
      // For image and video files, use the previous halves layout.
      let fileWidth = fileBox.offsetWidth;
      let fileHeight = fileBox.offsetHeight;
      let layoutType = (fileWidth > fileHeight) ? "horizontal" : "vertical";
      const layoutDiv = document.createElement("div");
      layoutDiv.classList.add("detail-layout", layoutType);
      
      const fileContainer = document.createElement("div");
      fileContainer.id = "detail-file-container";
      fileContainer.classList.add(layoutType);
      const textContainer = document.createElement("div");
      textContainer.id = "detail-text-container";
      textContainer.classList.add(layoutType);
      
      let mediaElement;
      if (fileBox.mediaType === "video") {
        mediaElement = fileBox.mediaElement;
        mediaElement.style.pointerEvents = "auto";
        if (mediaElement.parentElement === fileBox) {
          fileBox.removeChild(mediaElement);
        }
        currentDetailMediaInfo = { fileBox: fileBox, mediaElement: mediaElement };
        mediaElement.addEventListener("click", toggleMediaPlay);
      } else if (fileBox.mediaType === "image") {
        mediaElement = document.createElement("img");
        mediaElement.src = fileBox.querySelector("img").src;
      } else {
        mediaElement = fileBox.cloneNode(true);
      }
      
      fileContainer.appendChild(mediaElement);
      
      const textBox = document.createElement("textarea");
      textBox.id = "detail-text";
      textBox.placeholder = "Enter text here...";
      textBox.value = fileBox.savedText;
      textBox.addEventListener("input", function(){
        fileBox.savedText = textBox.value;
      });
      textContainer.appendChild(textBox);
      
      if (layoutType === "horizontal") {
        layoutDiv.appendChild(fileContainer);
        layoutDiv.appendChild(textContainer);
      } else {
        layoutDiv.appendChild(textContainer);
        layoutDiv.appendChild(fileContainer);
      }
      
      detailView.appendChild(layoutDiv);
    }
    
    function toggleMediaPlay(e) {
      const media = e.currentTarget;
      if (media.paused) {
        media.play();
      } else {
        media.pause();
      }
    }
    
    function audioVisualToggle(e) {
      if (!currentDetailMediaInfo || !currentDetailMediaInfo.mediaElement) return;
      const audio = currentDetailMediaInfo.mediaElement;
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
    }
    
    function updateAudioVisualColors(audio, visual) {
      if (!audio || !visual) return;
      const topDiv = visual.querySelector('.top-half');
      const bottomDiv = visual.querySelector('.bottom-half');
      if (audio.paused) {
        topDiv.style.backgroundColor = "red";
        bottomDiv.style.backgroundColor = "blue";
      } else {
        topDiv.style.backgroundColor = "#2fff00";
        bottomDiv.style.backgroundColor = "#b400ff";
      }
    }
    
    document.getElementById("detail-close").addEventListener("click", function() {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "none";
      
      if (currentDetailMediaInfo) {
        if (currentDetailMediaInfo.isAudio) {
          if (currentDetailMediaInfo.audioVisualContainer && currentDetailMediaInfo.audioVisualContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.audioVisualContainer);
          }
          if (currentDetailMediaInfo.blackBoxContainer && currentDetailMediaInfo.blackBoxContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.blackBoxContainer);
          }
          currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
        } else {
          if (currentDetailMediaInfo.mediaElement &&
              currentDetailMediaInfo.mediaElement.tagName.toLowerCase() === "video") {
            currentDetailMediaInfo.mediaElement.removeEventListener("click", toggleMediaPlay);
            currentDetailMediaInfo.mediaElement.style.pointerEvents = "none";
          }
          if (currentDetailMediaInfo.mediaVisual) {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
          } else {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaElement);
          }
        }
        currentDetailMediaInfo = null;
      }
    });
    
    // --- Default Layout Initialization ---
    // Here you can implement your default layout to display files and text
    // when the page first loads.
    window.onload = function() {
      drawLinesAndParallelogram();
      
      // Set default text in the editable area.
      document.querySelector('.editable').innerText = "Welcome! This is the default text.";
      
      // Create default file boxes.
      // (You can use your own URLs for default files.)
      createDefaultFileBox({ type: "image", src: "これアオちゃん2.JPG" });
      createDefaultFileBox({ type: "video", src: "sonder_2_1.mp4" });
      createDefaultFileBox({ type: "audio", src: "9-7 audio.mp3" });
      
      const fileInput = document.getElementById("file-input");
      fileInput.addEventListener("change", function(e) {
        handleFiles(e.target.files);
      });
      
      setupDragAndDrop();
    };
    
    // createDefaultFileBox simulates the creation of a file box from a default file object.
    function createDefaultFileBox(defaultFile) {
      const uploadContainer = document.getElementById("upload-container");
      const fileBox = document.createElement("div");
      fileBox.classList.add("file-box");
      // Initialize savedText property.
      fileBox.savedText = "";
      
      if (defaultFile.type === "image") {
        const img = new Image();
        img.onload = function() {
          const naturalWidth = img.naturalWidth;
          const naturalHeight = img.naturalHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(img);
          fileBox.mediaType = "image";
          fileBox.mediaElement = img;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        img.src = defaultFile.src;
      } else if (defaultFile.type === "video") {
        const video = document.createElement("video");
        video.loop = true;
        video.controls = false;
        video.style.pointerEvents = "none";
        video.onloadedmetadata = function() {
          const naturalWidth = video.videoWidth;
          const naturalHeight = video.videoHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          fileBox.appendChild(video);
          fileBox.mediaType = "video";
          fileBox.mediaElement = video;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        video.src = defaultFile.src;
      } else if (defaultFile.type === "audio") {
        // For audio, use a fixed 25x25px square.
        const newWidth = 25;
        const newHeight = 25;
        fileBox.style.width = newWidth + "px";
        fileBox.style.height = newHeight + "px";
        fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
        fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
        const audio = document.createElement("audio");
        audio.loop = true;
        audio.controls = false;
        audio.style.display = "none";
        audio.src = defaultFile.src;
        const audioBox = document.createElement("div");
        audioBox.className = "audio-box";
        const topDiv = document.createElement("div");
        topDiv.className = "top-half";
        const bottomDiv = document.createElement("div");
        bottomDiv.className = "bottom-half";
        audioBox.appendChild(topDiv);
        audioBox.appendChild(bottomDiv);
        fileBox.appendChild(audioBox);
        fileBox.appendChild(audio);
        fileBox.mediaType = "audio";
        fileBox.mediaElement = audio;
        fileBox.audioVisual = audioBox;
        saveRelativeDimensions(fileBox, uploadContainer);
        makeInteractive(fileBox);
        audio.addEventListener("play", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        audio.addEventListener("pause", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        updateAudioVisualColors(audio, fileBox.audioVisual);
      }
      
      fileBox.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Cut file?")) {
          fileBox.remove();
        }
      });
      
      fileBox.addEventListener("click", function(e) {
        if (fileBox.mediaType === "video" || fileBox.mediaType === "audio") {
          const media = fileBox.mediaElement;
          if (media.paused){
            media.play();
          } else {
            media.pause();
          }
        }
      });
      
      fileBox.addEventListener("dblclick", function(e) {
        openDetailView(fileBox);
      });
      
      uploadContainer.appendChild(fileBox);
    }
    
    // ------------------------------
    // INTERACTIVE (DRAG & RESIZE) FUNCTIONALITY
    // ------------------------------
    
    function makeInteractive(el) {
      const threshold = 10;
      el.addEventListener("mousedown", function(e) {
        e.preventDefault();
        const rect = {
          left: el.offsetLeft,
          top: el.offsetTop,
          width: el.offsetWidth,
          height: el.offsetHeight
        };
        const relativeX = e.offsetX;
        const relativeY = e.offsetY;
        let corner = null;
        if (relativeX < threshold && relativeY < threshold) {
          corner = "top-left";
        } else if (relativeX > rect.width - threshold && relativeY < threshold) {
          corner = "top-right";
        } else if (relativeX < threshold && relativeY > rect.height - threshold) {
          corner = "bottom-left";
        } else if (relativeX > rect.width - threshold && relativeY > rect.height - threshold) {
          corner = "bottom-right";
        }
        const parent = el.parentElement;
        function updateRelative() {
          el.dataset.relLeft = parseFloat(el.style.left) / parent.clientWidth;
          el.dataset.relTop = parseFloat(el.style.top) / parent.clientHeight;
          el.dataset.relWidth = parseFloat(el.style.width) / parent.clientWidth;
          el.dataset.relHeight = parseFloat(el.style.height) / parent.clientHeight;
        }
        if (corner) {
          document.body.style.cursor = (corner === "top-left" || corner === "bottom-right") ? "nwse-resize" : "nesw-resize";
          const startX = e.clientX, startY = e.clientY;
          const startWidth = rect.width, startHeight = rect.height;
          const startLeft = rect.left, startTop = rect.top;
          function resizeMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newWidth = startWidth, newHeight = startHeight;
            let newLeft = startLeft, newTop = startTop;
            if (corner === "top-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight - dy;
              newLeft = startLeft + dx;
              newTop = startTop + dy;
            } else if (corner === "top-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight - dy;
              newTop = startTop + dy;
            } else if (corner === "bottom-left") {
              newWidth = startWidth - dx;
              newHeight = startHeight + dy;
              newLeft = startLeft + dx;
            } else if (corner === "bottom-right") {
              newWidth = startWidth + dx;
              newHeight = startHeight + dy;
            }
            newWidth = Math.max(newWidth, 30);
            newHeight = Math.max(newHeight, 30);
            newLeft = Math.max(0, newLeft);
            newTop = Math.max(0, newTop);
            if(newLeft + newWidth > parent.clientWidth){
              newWidth = parent.clientWidth - newLeft;
            }
            if(newTop + newHeight > parent.clientHeight){
              newHeight = parent.clientHeight - newTop;
            }
            el.style.width = newWidth + "px";
            el.style.height = newHeight + "px";
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function resizeEnd() {
            document.body.style.cursor = "default";
            document.removeEventListener("mousemove", resizeMove);
            document.removeEventListener("mouseup", resizeEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", resizeMove);
          document.addEventListener("mouseup", resizeEnd);
        } else {
          parent.style.outline = "2px solid red";
          const startX = e.clientX, startY = e.clientY;
          const startLeft = el.offsetLeft;
          const startTop = el.offsetTop;
          function dragMove(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            newLeft = Math.max(0, Math.min(newLeft, parent.clientWidth - el.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, parent.clientHeight - el.offsetHeight));
            el.style.left = newLeft + "px";
            el.style.top = newTop + "px";
          }
          function dragEnd() {
            parent.style.outline = "";
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", dragEnd);
            updateRelative();
          }
          document.addEventListener("mousemove", dragMove);
          document.addEventListener("mouseup", dragEnd);
        }
      });
    }
    
    // ------------------------------
    // VIEW MODE FUNCTIONALITY (Double-Click)
    // ------------------------------
    
    function openDetailView(fileBox) {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "block";
      detailView.querySelectorAll(".detail-layout").forEach(el => el.remove());
      
      // Ensure savedText exists.
      if (typeof fileBox.savedText === "undefined") {
        fileBox.savedText = "";
      }
      
     if (fileBox.mediaType === "audio") {
  const audioVisual = fileBox.audioVisual;
  if (audioVisual && audioVisual.parentElement === fileBox) {
    fileBox.removeChild(audioVisual);
  }
  const audioVisualContainer = document.createElement("div");
  audioVisualContainer.id = "audioVisualContainer";
  audioVisualContainer.style.position = "absolute";
  audioVisualContainer.style.top = "0";
  audioVisualContainer.style.left = "0";
  audioVisualContainer.style.width = "100vw";
  audioVisualContainer.style.height = "100vh";
  audioVisualContainer.style.zIndex = "1";
  audioVisual.style.width = "100%";
  audioVisual.style.height = "100%";
  audioVisualContainer.appendChild(audioVisual);
  
  // Make the audioVisualContainer toggle play/pause when clicked.
  audioVisualContainer.addEventListener("click", function(){
    const audio = fileBox.mediaElement;
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
  });
  
  const blackBoxContainer = document.createElement("div");
  blackBoxContainer.style.position = "absolute";
  blackBoxContainer.style.top = "50%";
  blackBoxContainer.style.left = "50%";
  blackBoxContainer.style.transform = "translate(-50%, -50%)";
  blackBoxContainer.style.width = "34vw";
  blackBoxContainer.style.height = "34vh";
  blackBoxContainer.style.backgroundColor = "black";
  blackBoxContainer.style.zIndex = "2";
  
  // Set default text if none exists
  if (fileBox.savedText === "") {
    fileBox.savedText = "Default audio caption text.";
  }
  
  const textBox = document.createElement("textarea");
  textBox.id = "detail-text";
  textBox.placeholder = "Enter text here...";
  textBox.style.width = "100%";
  textBox.style.height = "100%";
  textBox.style.background = "transparent";
  textBox.style.border = "none";
  textBox.style.outline = "none";
  textBox.style.color = "white";
  textBox.style.fontFamily = "monospace";
  textBox.style.fontSize = "3vw";
  textBox.style.resize = "none";
  textBox.value = "healing hrtz\n\ncurrent draft created 9-7-2024";
  textBox.addEventListener("input", function(){
    fileBox.savedText = "hello babe";
  });
  blackBoxContainer.appendChild(textBox);
  
  detailView.appendChild(audioVisualContainer);
  detailView.appendChild(blackBoxContainer);
  
  currentDetailMediaInfo = { 
    fileBox: fileBox, 
    mediaVisual: audioVisual, 
    audioVisualContainer: audioVisualContainer, 
    blackBoxContainer: blackBoxContainer, 
    isAudio: true, 
    mediaElement: fileBox.mediaElement 
  };
  return;
}

      
      // For image and video files, use the previous halves layout.
      let fileWidth = fileBox.offsetWidth;
      let fileHeight = fileBox.offsetHeight;
      let layoutType = (fileWidth > fileHeight) ? "horizontal" : "vertical";
      const layoutDiv = document.createElement("div");
      layoutDiv.classList.add("detail-layout", layoutType);
      
      const fileContainer = document.createElement("div");
      fileContainer.id = "detail-file-container";
      fileContainer.classList.add(layoutType);
      const textContainer = document.createElement("div");
      textContainer.id = "detail-text-container";
      textContainer.classList.add(layoutType);
      
      let mediaElement;
      if (fileBox.mediaType === "video") {
        mediaElement = fileBox.mediaElement;
        mediaElement.style.pointerEvents = "auto";
        if (mediaElement.parentElement === fileBox) {
          fileBox.removeChild(mediaElement);
        }
        currentDetailMediaInfo = { fileBox: fileBox, mediaElement: mediaElement };
        mediaElement.addEventListener("click", toggleMediaPlay);
      } else if (fileBox.mediaType === "image") {
        mediaElement = document.createElement("img");
        mediaElement.src = fileBox.querySelector("img").src;
      } else {
        mediaElement = fileBox.cloneNode(true);
      }
      
      fileContainer.appendChild(mediaElement);
      
      const textBox = document.createElement("textarea");
      textBox.id = "detail-text";
      textBox.placeholder = "Enter text here...";
      textBox.value = fileBox.savedText;
      textBox.addEventListener("input", function(){
        fileBox.savedText = textBox.value;
      });
      textContainer.appendChild(textBox);
      
      if (layoutType === "horizontal") {
        layoutDiv.appendChild(fileContainer);
        layoutDiv.appendChild(textContainer);
      } else {
        layoutDiv.appendChild(textContainer);
        layoutDiv.appendChild(fileContainer);
      }
      
      detailView.appendChild(layoutDiv);
    }
    
    function toggleMediaPlay(e) {
      const media = e.currentTarget;
      if (media.paused) {
        media.play();
      } else {
        media.pause();
      }
    }
    
    function audioVisualToggle(e) {
      if (!currentDetailMediaInfo || !currentDetailMediaInfo.mediaElement) return;
      const audio = currentDetailMediaInfo.mediaElement;
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
    }
    
    function updateAudioVisualColors(audio, visual) {
      if (!audio || !visual) return;
      const topDiv = visual.querySelector('.top-half');
      const bottomDiv = visual.querySelector('.bottom-half');
      if (audio.paused) {
        topDiv.style.backgroundColor = "red";
        bottomDiv.style.backgroundColor = "blue";
      } else {
        topDiv.style.backgroundColor = "#2fff00";
        bottomDiv.style.backgroundColor = "#b400ff";
      }
    }
    
    document.getElementById("detail-close").addEventListener("click", function() {
      const detailView = document.getElementById("detail-view");
      detailView.style.display = "none";
      
      if (currentDetailMediaInfo) {
        if (currentDetailMediaInfo.isAudio) {
          if (currentDetailMediaInfo.audioVisualContainer && currentDetailMediaInfo.audioVisualContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.audioVisualContainer);
          }
          if (currentDetailMediaInfo.blackBoxContainer && currentDetailMediaInfo.blackBoxContainer.parentElement === detailView) {
            detailView.removeChild(currentDetailMediaInfo.blackBoxContainer);
          }
          currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
        } else {
          if (currentDetailMediaInfo.mediaElement &&
              currentDetailMediaInfo.mediaElement.tagName.toLowerCase() === "video") {
            currentDetailMediaInfo.mediaElement.removeEventListener("click", toggleMediaPlay);
            currentDetailMediaInfo.mediaElement.style.pointerEvents = "none";
          }
          if (currentDetailMediaInfo.mediaVisual) {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaVisual);
          } else {
            currentDetailMediaInfo.fileBox.appendChild(currentDetailMediaInfo.mediaElement);
          }
        }
        currentDetailMediaInfo = null;
      }
    });
    
    // --- Default Layout Initialization ---
    // When the page loads, we preset default text and default file boxes.
    window.onload = function() {
      drawLinesAndParallelogram();
      
      // Set default text in the editable area.
      document.querySelector('.editable').innerText = "展自へようこそ\nwelcome to tenji\n\nmake the space yours";
      
      // Create default file boxes.
      // Adjust the URLs below as needed.
      createDefaultFileBox({ type: "image", src: "aochan.jpg", });
      createDefaultFileBox({ type: "video", src: "sonder_2_1.mp4" });
      createDefaultFileBox({ type: "audio", src: "9-7 audio.mp3" });
      
      const fileInput = document.getElementById("file-input");
      fileInput.addEventListener("change", function(e) {
        handleFiles(e.target.files);
      });
      
      setupDragAndDrop();
    };
    
    // createDefaultFileBox uses default file data (type and src) to mimic createFileBox().
    function createDefaultFileBox(defaultFile) {
      const uploadContainer = document.getElementById("upload-container");
      const fileBox = document.createElement("div");
      fileBox.classList.add("file-box");
      fileBox.savedText = "T-Shirt Design for アオちゃん「Ao-Chan」\n\n アオちゃんwas my coworker for a café I worked at. She's an amazing pastry chef, who's super hard working, always fasionable, and was one of the nicest people to me in Japan. She was a great older-sister figure to me, and on the last day I met her, I made this shirt for her. \n\n In the top right, the blue apron was our standard issue work uniform. Caption says: 「The Ao-Chan that always works hard at work」In the bottom left is my attempt *ATTEMPT* at making fake Japanese fasion. The shirt says IM COOL YO. The caption says 「The Ao-chan that's always fashionable」The bottom right features an Ao-Chan in a Tiger suit. Ao-Chan is slightly older than her boyfriend, so one day during work I was explaining the concept of a cougar, which thought was funny. it became a small inside joke. It was my impression that Japanese people are not familar between distinguishing cougars and other big cats, so I simplfied the concept to a tiger. It features the 「Tiger-fied Ao-Chan」 ready to *pounce* on her prey. The sunflowers come from the kanji for Ao-Chan's uncontracted name Aoi: 葵 is the same character as the third kanji in 向日葵, meaning sunflower. Ao-Chan also loves her cat, so that's a random picture of a cat rastified. The hand drawn characters at the top say *Aoi's T-shirt, do not steal* 「my one-chan is mecha steki yo」means, *my older sister is totally rad* in too-casual Nipponglish";
      
      if (defaultFile.type === "image") {
        const img = new Image();
        img.onload = function() {
          const naturalWidth = img.naturalWidth;
          const naturalHeight = img.naturalHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
          
           fileBox.style.transform = "translateX(-250px)";
          
          fileBox.appendChild(img);
          fileBox.mediaType = "image";
          fileBox.mediaElement = img;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        img.src = defaultFile.src;
      } else if (defaultFile.type === "video") {
        const video = document.createElement("video");
        fileBox.savedText = defaultFile.defaultText || "ソンダー「sonder」\n\n\nsonder\nnoun\n  - the feeling one has on realizing that every other individual one sees has a life as full and real as one’s own, in which they are the central character and others, including oneself, have secondary or insignificant roles";
        video.loop = true;
        video.controls = false;
        video.style.pointerEvents = "none";
        video.onloadedmetadata = function() {
          const naturalWidth = video.videoWidth;
          const naturalHeight = video.videoHeight;
          const scale = Math.min(1, uploadContainer.clientWidth / naturalWidth, uploadContainer.clientHeight / naturalHeight);
          const newWidth = naturalWidth * scale;
          const newHeight = naturalHeight * scale;
          fileBox.style.width = newWidth + "px";
          fileBox.style.height = newHeight + "px";
          fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
          fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
           fileBox.style.transform = "translateX(280px)";
          fileBox.appendChild(video);
          fileBox.mediaType = "video";
          fileBox.mediaElement = video;
          saveRelativeDimensions(fileBox, uploadContainer);
          makeInteractive(fileBox);
        };
        video.src = defaultFile.src;
      } else if (defaultFile.type === "audio") {
        // For audio, use a fixed 25x25px square.
        const newWidth = 25;
        const newHeight = 25;
        fileBox.style.width = newWidth + "px";
        fileBox.style.height = newHeight + "px";
        fileBox.style.left = ((uploadContainer.clientWidth - newWidth) / 2) + "px";
        fileBox.style.top = ((uploadContainer.clientHeight - newHeight) / 2) + "px";
        const audio = document.createElement("audio");
        audio.loop = true;
        audio.controls = false;
        audio.style.display = "none";
        audio.src = defaultFile.src;
        const audioBox = document.createElement("div");
        audioBox.className = "audio-box";
        const topDiv = document.createElement("div");
        topDiv.className = "top-half";
        const bottomDiv = document.createElement("div");
        bottomDiv.className = "bottom-half";
        audioBox.appendChild(topDiv);
        audioBox.appendChild(bottomDiv);
        fileBox.appendChild(audioBox);
        fileBox.appendChild(audio);
        fileBox.mediaType = "audio";
        fileBox.mediaElement = audio;
        fileBox.audioVisual = audioBox;
         fileBox.style.transform = "translateY(50px) translateX(35px) scale(6.5,1.5)";
        saveRelativeDimensions(fileBox, uploadContainer);
        makeInteractive(fileBox);
        audio.addEventListener("play", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        audio.addEventListener("pause", () => {
          if (fileBox.audioVisual) {
            updateAudioVisualColors(audio, fileBox.audioVisual);
          }
          if (currentDetailMediaInfo && currentDetailMediaInfo.fileBox === fileBox && currentDetailMediaInfo.mediaVisual) {
            updateAudioVisualColors(audio, currentDetailMediaInfo.mediaVisual);
          }
        });
        updateAudioVisualColors(audio, fileBox.audioVisual);
      }
      
      fileBox.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Cut file?")) {
          fileBox.remove();
        }
      });
      
      fileBox.addEventListener("click", function(e) {
        if (fileBox.mediaType === "video" || fileBox.mediaType === "audio") {
          const media = fileBox.mediaElement;
          if (media.paused){
            media.play();
          } else {
            media.pause();
          }
        }
      });
      
      fileBox.addEventListener("dblclick", function(e) {
        openDetailView(fileBox);
      });
      
      uploadContainer.appendChild(fileBox);
    }
    
    // ------------------------------
    // WINDOW LOAD & RESIZE
    // ------------------------------
    
    window.onresize = function() {
      drawLinesAndParallelogram();
      updateFileBoxesPositions();
    };
  </script>
  
</body>
</html>
